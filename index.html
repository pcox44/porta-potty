<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Porta Potty Simulator with Top K Probability</title>
<style>
body {
  font-family: 'Segoe UI', sans-serif;
  background: linear-gradient(135deg, #1a1a1a, #2b2b2b);
  color: #fff;
  text-align: center;
  padding: 20px;
}
h1 { margin-bottom: 10px; color: #ffce00; }
p.description { margin: 0 0 20px; font-size: 1em; color: #ddd; }
.controls { margin: 20px 0; }
input[type=range], input[type=number] { width: 200px; }
button { margin: 5px; padding: 8px 15px; font-weight: bold; cursor: pointer; border-radius: 5px; border: none; background: #ffce00; color: #000; }
button:hover { background: #ffc107; }
#applicants {
  display: grid;
  grid-template-columns: repeat(10, 40px);
  justify-content: center;
  gap: 6px;
  margin-top: 20px;
}
.applicant {
  width: 35px; height: 35px;
  border-radius: 50%;
  display: flex;
  justify-content: center;
  align-items: center;
  font-size: 0.8em;
  font-weight: bold;
  color: #fff;
  background: gray;
  position: relative;
  transition: transform 0.3s, box-shadow 0.3s, background 0.3s;
  cursor: default;
}
.applicant.selected { box-shadow: 0 0 10px 3px #ff0000; transform: scale(1.3); animation: pulse 0.6s infinite alternate; }
.applicant.skip { background: rgba(255,255,0,0.5); color: #000; }
.applicant.best { background: green; color: #fff; }
.applicant.topK { background: orange; color: #fff; }
.applicant:hover::after {
  content: attr(data-tooltip);
  position: absolute;
  top: -25px;
  left: 50%;
  transform: translateX(-50%);
  background: #333;
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 0.7em;
  white-space: nowrap;
  pointer-events: none;
}
@keyframes pulse {
  0% { transform: scale(1.3); box-shadow: 0 0 10px 3px #ff0000; }
  100% { transform: scale(1.5); box-shadow: 0 0 20px 6px #ff0000; }
}
#stats { margin-top: 20px; font-size: 1.1em; }
#graphCanvas {
  margin-top: 20px;
  background: linear-gradient(to top, #111, #222);
  border: 1px solid #fff;
}
#topKInfo {
  margin-top: 10px;
  font-size: 1em;
  color: #00ff00;
}
</style>
</head>
<body>

<h1>Porta Potty Simulator</h1>
<p class="description">Pick a porta potty as you walk by! You cannot return once skipped. Use the simulations below to see probabilities of selecting a top K potty.</p>

<div class="controls">
  <label>Number of potties: <span id="numLabel">50</span></label><br>
  <input type="range" id="numApplicants" min="10" max="100" value="50"><br>

  <label>Stop after fraction: <span id="stopLabel">0.37</span></label><br>
  <input type="range" id="stopFraction" min="0.05" max="0.95" step="0.01" value="0.37"><br>

  <label><input type="checkbox" id="setE"> Set stop fraction to 1/e</label><br>

  <label>Top k goal: <input type="number" id="topKInput" min="1" max="10" value="5"></label><br>

  <button onclick="runSimulation()">Run 1 Trial</button>
  <button onclick="runMultiple(100)">Run 100 Trials</button>
  <button onclick="resetAll()">Reset</button>
  <button onclick="plotTopK()">Plot Top K Probability Curve</button>
</div>

<div id="applicants"></div>
<div id="stats"></div>
<div id="topKInfo"></div>
<canvas id="graphCanvas" width="900" height="350"></canvas>

<script>
const applicantsDiv = document.getElementById('applicants');
const numApplicantsInput = document.getElementById('numApplicants');
const stopFractionInput = document.getElementById('stopFraction');
const numLabel = document.getElementById('numLabel');
const stopLabel = document.getElementById('stopLabel');
const statsDiv = document.getElementById('stats');
const topKInput = document.getElementById('topKInput');
const setECheckbox = document.getElementById('setE');
const canvas = document.getElementById('graphCanvas');
const ctx = canvas.getContext('2d');
const topKInfoDiv = document.getElementById('topKInfo');

numApplicantsInput.oninput = () => numLabel.textContent = numApplicantsInput.value;
stopFractionInput.oninput = () => { stopLabel.textContent = stopFractionInput.value; setECheckbox.checked=false; };
setECheckbox.onchange = () => { if(setECheckbox.checked){ stopFractionInput.value = (1/Math.E).toFixed(2); stopLabel.textContent = stopFractionInput.value; } };

let averageRanks = [];
let topKProbs = [];

function createApplicants(n){
  const arr = Array.from({length:n}, (_,i)=>i+1);
  for(let i=arr.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  return arr;
}

function displayApplicants(arr, selectedIndex=-1, stopIndex=0, topK=5){
  applicantsDiv.innerHTML='';
  arr.forEach((rank,i)=>{
    const div = document.createElement('div');
    div.className='applicant';
    div.textContent=rank;
    div.dataset.tooltip=`Rank: ${rank}, Position: ${i+1}`;
    if(i<stopIndex) div.classList.add('skip');
    if(i===selectedIndex) {
      div.classList.add('selected');
      if(rank===1) div.classList.add('best');
      else if(rank <= topK) div.classList.add('topK');
    }
    applicantsDiv.appendChild(div);
  });
}

function runSingleTrial(n, stopFrac){
  const topK = parseInt(topKInput.value);
  const applicants = createApplicants(n);
  const stop = Math.floor(n*stopFrac);
  let bestSeen = n+1;
  let selectedIndex = -1;
  for(let i=0;i<n;i++){
    if(i<stop) bestSeen=Math.min(bestSeen, applicants[i]);
    else if(applicants[i]<bestSeen){selectedIndex=i; break;}
  }
  if(selectedIndex===-1) selectedIndex=n-1;
  displayApplicants(applicants, selectedIndex, stop, topK);
  const selectedRank = applicants[selectedIndex];
  return {
    selectedRank,
    success: selectedRank===1?1:0,
    topKSuccess: selectedRank <= topK?1:0
  };
}

function runSimulation(){
  const n = parseInt(numApplicantsInput.value);
  const stopFrac = parseFloat(stopFractionInput.value);
  const result = runSingleTrial(n, stopFrac);
  averageRanks.push(result.selectedRank);
  updateStats(result.success, result.topKSuccess, 1);
  drawGraph();
}

function runMultiple(trials){
  const n = parseInt(numApplicantsInput.value);
  const stopFrac = parseFloat(stopFractionInput.value);
  let cumulative = averageRanks.length > 0 ? averageRanks[averageRanks.length-1]*averageRanks.length : 0;
  let successes = 0;
  let topKSuccess = 0;
  for(let i=0;i<trials;i++){
    const res = runSingleTrial(n, stopFrac);
    cumulative += res.selectedRank;
    averageRanks.push(cumulative/(averageRanks.length));
    successes += res.success;
    topKSuccess += res.topKSuccess;
  }
  updateStats(successes, topKSuccess, trials);
  drawGraph();
}

function updateStats(successes=0, topKSuccess=0, trials=1){
  const last = averageRanks[averageRanks.length-1] || 0;
  const topK = parseInt(topKInput.value);
  statsDiv.innerHTML=`
    Average selected rank: ${last.toFixed(2)}<br>
    Success rate (#1 selected): ${successes}/${trials} (${(successes/trials*100).toFixed(2)}%)<br>
    Top ${topK} success rate: ${topKSuccess}/${trials} (${(topKSuccess/trials*100).toFixed(2)}%)<br>
    Stop fraction: ${stopFractionInput.value} 
  `;
}

// ---- Top K probability plotting ----
function plotTopK(){
  const n = parseInt(numApplicantsInput.value);
  const topK = parseInt(topKInput.value);
  const trialsPerR = 500; // can adjust for speed
  const fractions = [];
  for(let r=0.01; r<=0.99; r+=0.01) fractions.push(parseFloat(r.toFixed(2)));
  topKProbs = [];
  topKInfoDiv.innerHTML = 'Calculating probabilities...';
  let idx=0;
  function next(){
    if(idx>=fractions.length){
      drawGraph();
      // find fraction with max probability
      let maxP = Math.max(...topKProbs.map(p=>p.prob));
      let maxFrac = topKProbs.find(p=>p.prob===maxP).frac;
      topKInfoDiv.innerHTML = `Max Top ${topK} chance: ${(maxP*100).toFixed(2)}% at stop fraction â‰ˆ ${maxFrac.toFixed(2)}`;
      return;
    }
    const r = fractions[idx];
    let topKSuccess = 0;
    for(let t=0;t<trialsPerR;t++){
      const res = runSingleTrial(n,r);
      topKSuccess += res.topKSuccess;
    }
    topKProbs.push({frac:r, prob: topKSuccess/trialsPerR});
    idx++;
    setTimeout(next,10);
  }
  next();
}

function drawGraph(){
  const w = canvas.width;
  const h = canvas.height;
  ctx.clearRect(0,0,w,h);
  const padding = 50;
  const graphWidth = w - padding*2;
  const graphHeight = h - padding*2;

  // axes
  ctx.strokeStyle = '#fff';
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(padding,padding);
  ctx.lineTo(padding,h-padding);
  ctx.lineTo(w-padding,h-padding);
  ctx.stroke();

  // Y-axis labels 0-100%
  ctx.textAlign = 'right';
  ctx.textBaseline = 'middle';
  const yTicks = 5;
  for(let i=0;i<=yTicks;i++){
    const yVal = i/yTicks;
    const y = h-padding - yVal*graphHeight;
    ctx.beginPath();
    ctx.moveTo(padding-5,y);
    ctx.lineTo(padding,y);
    ctx.stroke();
    ctx.fillStyle = '#fff';
    ctx.fillText((yVal*100).toFixed(0)+'%', padding-10, y);
  }

  // X-axis labels
  ctx.textAlign = 'center';
  ctx.textBaseline = 'top';
  const xTicks = 10;
  for(let i=0;i<=xTicks;i++){
    const xIndex = Math.round(i/xTicks*(topKProbs.length-1));
    const x = padding + (xIndex/(topKProbs.length-1))*graphWidth;
    const frac = topKProbs[xIndex]?.frac || 0;
    ctx.beginPath();
    ctx.moveTo(x,h-padding);
    ctx.lineTo(x,h-padding+5);
    ctx.stroke();
    ctx.fillStyle = '#fff';
    ctx.fillText(frac.toFixed(2), x, h-padding+7);
  }

  // Y-axis label
  ctx.save();
  ctx.translate(15,h/2);
  ctx.rotate(-Math.PI/2);
  ctx.textAlign='center';
  ctx.textBaseline='middle';
  ctx.fillText('Chance of Top K Selection',0,0);
  ctx.restore();

  // X-axis label
  ctx.fillText('Stop After Fraction', w/2, h-10);

  // plot green line
  if(topKProbs.length>0){
    ctx.strokeStyle = '#00ff00';
    ctx.lineWidth = 2;
    ctx.beginPath();
    topKProbs.forEach((p,i)=>{
      const x = padding + (i/(topKProbs.length-1))*graphWidth;
      const y = h-padding - p.prob*graphHeight;
      if(i===0) ctx.moveTo(x,y);
      else ctx.lineTo(x,y);
    });
    ctx.stroke();

    // vertical line at max probability
    const maxP = Math.max(...topKProbs.map(p=>p.prob));
    const maxFrac = topKProbs.find(p=>p.prob===maxP).frac;
    const xMax = padding + (maxFrac*(graphWidth));
    ctx.strokeStyle = '#ff00ff';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(xMax,padding);
    ctx.lineTo(xMax,h-padding);
    ctx.stroke();

    // label vertical line
    ctx.fillStyle = '#ff00ff';
    ctx.textAlign = 'left';
    ctx.textBaseline = 'top';
    ctx.fillText(`Max: ${(maxP*100).toFixed(1)}% at ${maxFrac.toFixed(2)}`, xMax+5,padding+5);
  }
}

function resetAll(){
  averageRanks=[];
  topKProbs=[];
  ctx.clearRect(0,0,canvas.width,canvas.height);
  statsDiv.innerHTML='';
  topKInfoDiv.innerHTML='';
  applicantsDiv.innerHTML='';
}
</script>
</body>
</html>
